name: Auto-merge Copilot PRs

# Trigger this workflow when a PR is opened, updated, or reopened
on:
  pull_request:
    types: [opened, synchronize, reopened]

# Required permissions for approving and merging PRs
permissions:
  contents: write          # Required to merge PRs
  pull-requests: write     # Required to approve and modify PRs

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    # Only run this workflow for PRs created by trusted bots
    # This prevents unauthorized auto-merges from other users
    # GitHub Copilot Workspace uses 'github-actions[bot]' as the actor
    # Also ensure this is not running on a fork (security measure)
    if: |
      github.event.pull_request.user.login == 'github-actions[bot]' &&
      github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      # Step 1: Log the PR information for transparency
      - name: Log PR Information
        run: |
          echo "ü§ñ Auto-merge workflow triggered for Copilot PR"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}"
      
      # Step 2: Approve the PR
      # Using GitHub CLI to approve the PR from the workflow
      # The --auto flag in the merge step will wait for all required checks
      - name: Approve PR
        run: |
          echo "üëç Approving PR #${{ github.event.pull_request.number }}..."
          gh pr review "${{ github.event.pull_request.number }}" \
            --approve \
            --body "‚úÖ Auto-approved by Copilot auto-merge workflow. This PR was created by a trusted bot."
          echo "‚úÖ PR approved successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false
      
      # Step 3: Enable auto-merge with squash method
      # This will automatically merge once all required checks pass
      # The --auto flag ensures the PR waits for all required status checks
      - name: Enable auto-merge
        run: |
          echo "üîÄ Enabling auto-merge for PR #${{ github.event.pull_request.number }}..."
          # Enable auto-merge with squash method
          gh pr merge "${{ github.event.pull_request.number }}" \
            --squash \
            --auto
          echo "‚úÖ Auto-merge enabled successfully"
          echo "üìù Merge method: squash"
          echo "‚è≥ PR will merge automatically once all required checks pass"
          
          # Try to delete the branch, but don't fail if it's not possible
          # (e.g., fork PRs or permission issues)
          gh pr merge "${{ github.event.pull_request.number }}" --delete-branch 2>/dev/null || \
            echo "‚ÑπÔ∏è  Branch will not be auto-deleted (may be from fork or permissions issue)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false
      
      # Step 4: Log completion
      - name: Log completion
        if: success()
        run: |
          echo "‚ú® Auto-merge workflow completed successfully"
          echo "‚è≥ PR will be merged automatically once all required checks pass"
      
      # Step 5: Handle errors
      - name: Handle errors
        if: failure()
        run: |
          echo "‚ùå Auto-merge workflow failed"
          echo "Please review the PR manually: ${{ github.event.pull_request.html_url }}"
          exit 1
