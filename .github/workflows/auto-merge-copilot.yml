name: Auto-merge Copilot PRs

# Trigger this workflow when a PR is opened, updated, reopened, edited, or marked ready for review
# The 'edited' and 'converted_to_draft' types are crucial for detecting draft PR status changes
on:
  pull_request:
    types: 
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - edited              # Detects changes to draft status
      - converted_to_draft  # Detects conversion to draft
  pull_request_target:
    types: 
      - opened
      - synchronize
      - reopened
      - edited              # Detects changes to draft status

# Required permissions for approving and merging PRs
permissions:
  contents: write          # Required to merge PRs
  pull-requests: write     # Required to approve and modify PRs

jobs:
  # Single unified job to handle draft conversion and auto-merge
  auto-merge-copilot:
    runs-on: ubuntu-latest
    
    # Only run for PRs from Copilot or GitHub Actions bots in the same repository
    # Using contains() instead of exact match for flexible bot name detection
    if: |
      (
        contains(github.event.pull_request.user.login, 'copilot') || 
        contains(github.event.pull_request.user.login, 'github-actions')
      ) &&
      github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      # Debug step: Log detailed event information for troubleshooting
      - name: Debug Event Information
        run: |
          echo "üîç ========== Workflow Debug Information =========="
          echo "Event Name: ${{ github.event_name }}"
          echo "Event Action: ${{ github.event.action }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Draft Status: ${{ github.event.pull_request.draft }}"
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}"
          echo "Repository: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "=================================================="
      
      # Convert draft PR to ready for review if needed
      - name: Convert draft to ready for review
        if: github.event.pull_request.draft == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('üìù Draft PR detected from bot');
            console.log('‚è≥ Waiting 30 seconds for agent to finish work...');
            await new Promise(resolve => setTimeout(resolve, 30000));
            
            console.log('üîÑ Converting draft PR to ready for review...');
            try {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                draft: false
              });
              console.log('‚úÖ Draft PR successfully converted to ready for review');
            } catch (error) {
              console.error('‚ùå Failed to convert draft PR:', error.message);
              throw error;
            }
      
      # Wait a moment for the PR state to update after conversion
      - name: Wait for PR state update
        if: github.event.pull_request.draft == true
        run: |
          echo "‚è≥ Waiting 5 seconds for PR state to update..."
          sleep 5
      
      # Approve and merge the PR
      - name: Approve and merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            
            console.log('ü§ñ Processing auto-merge for Copilot PR #' + prNumber);
            
            // Step 1: Approve the PR
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: '‚úÖ Auto-approved by Copilot auto-merge workflow. This PR was created by a trusted bot.'
              });
              console.log('‚úÖ PR approved successfully');
            } catch (error) {
              // Approval might fail if already approved or if we're the PR author
              console.log('‚ÑπÔ∏è  Approval skipped (may already be approved):', error.message);
            }
            
            // Step 2: Wait a moment before merging
            console.log('‚è≥ Waiting 2 seconds before merge...');
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Step 3: Merge the PR using squash method
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              console.log('‚úÖ PR merged successfully using squash method');
            } catch (error) {
              console.error('‚ùå Merge failed:', error.message);
              console.error('Full error:', error);
              throw error;
            }
      
      # Log completion
      - name: Log completion
        if: success()
        run: |
          echo "‚ú® =========================================="
          echo "‚ú® Auto-merge workflow completed successfully"
          echo "‚ú® PR #${{ github.event.pull_request.number }} has been merged"
          echo "‚ú® =========================================="
      
      # Handle errors
      - name: Handle errors
        if: failure()
        run: |
          echo "‚ùå =========================================="
          echo "‚ùå Auto-merge workflow failed"
          echo "‚ùå Please review the PR manually:"
          echo "‚ùå ${{ github.event.pull_request.html_url }}"
          echo "‚ùå =========================================="
